<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PAIHO 3D Snake</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: sans-serif; background-color: #f1f5f9; margin: 0; padding: 0; overflow: hidden; touch-action: none; }
        #root { height: 100vh; display: flex; flex-direction: column; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, forwardRef, useImperativeHandle } = React;

        const GameCanvas = forwardRef(({ onScoreChange }, ref) => {
            const containerRef = useRef();
            const stateRef = useRef({ pos: new THREE.Vector3(0, 0.6, 0), dir: new THREE.Vector3(0, 0, -1), history: [] });

            useImperativeHandle(ref, () => ({
                setDirection: (x, z) => { stateRef.current.dir.set(x, 0, -z).normalize(); },
                reset: () => { stateRef.current.pos.set(0, 0.6, 0); stateRef.current.history = []; }
            }));

            useEffect(() => {
                const scene = new THREE.Scene();
                scene.background = new THREE.Color(0xf1f5f9);
                const camera = new THREE.OrthographicCamera(-20, 20, 20, -20, 0.1, 1000);
                camera.position.set(20, 20, 20); camera.lookAt(0, 0, 0);
                
                const renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(containerRef.current.clientWidth, containerRef.current.clientHeight);
                containerRef.current.appendChild(renderer.domElement);

                scene.add(new THREE.AmbientLight(0xffffff, 0.8));
                scene.add(new THREE.GridHelper(40, 20));

                // 蛇頭 (代表百和產品)
                const head = new THREE.Mesh(new THREE.BoxGeometry(2, 2, 2), new THREE.MeshStandardMaterial({ color: 0xD31A24 }));
                scene.add(head);

                let rid;
                const animate = () => {
                    rid = requestAnimationFrame(animate);
                    const s = stateRef.current;
                    s.pos.add(s.dir.clone().multiplyScalar(0.2));
                    head.position.copy(s.pos);
                    renderer.render(scene, camera);
                };
                animate();
                return () => cancelAnimationFrame(rid);
            }, []);

            return <div ref={containerRef} style={{ width: '100%', height: '100%' }} />;
        });

        const App = () => {
            const gameRef = useRef();
            const btnStyle = "w-16 h-16 bg-red-600 text-white rounded-full font-bold text-xl active:bg-red-800";
            
            return (
                <div className="flex flex-col h-full">
                    <header className="p-4 bg-white shadow flex justify-between items-center">
                        <h1 className="font-bold text-xl">PAIHO SNAKE</h1>
                    </header>
                    <div className="flex-1 relative bg-slate-200">
                        <GameCanvas ref={gameRef} />
                    </div>
                    <div className="p-8 bg-slate-300 grid grid-cols-3 gap-2 justify-items-center">
                        <div />
                        <button className={btnStyle} onPointerDown={() => gameRef.current.setDirection(0, 1)}>▲</button>
                        <div />
                        <button className={btnStyle} onPointerDown={() => gameRef.current.setDirection(-1, 0)}>◀</button>
                        <button className={btnStyle} onPointerDown={() => gameRef.current.setDirection(0, -1)}>▼</button>
                        <button className={btnStyle} onPointerDown={() => gameRef.current.setDirection(1, 0)}>▶</button>
                    </div>
                </div>
            );
        };

        // React 17 的渲染方式，這在 GitHub Pages 最穩定
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
