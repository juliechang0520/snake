<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PAIHO 3D Elite - Impact Edition</title>
    <style>
        :root { --paiho-red: #e60012; }
        body { margin: 0; background: #000; overflow: hidden; display: flex; flex-direction: column; height: 100vh; font-family: sans-serif; }
        #header { height: 10%; background: #111; display: flex; align-items: center; justify-content: center; color: white; border-bottom: 3px solid var(--paiho-red); z-index: 10; }
        #game-container { flex: 1; position: relative; overflow: hidden; background: #1a1a1a; }
        
        /* 3D 操控按鈕 */
        #controls { height: 25%; background: #d1d9e6; display: grid; grid-template-columns: repeat(3, 1fr); align-items: center; justify-items: center; border-top: 5px solid #888; box-shadow: inset 0 10px 20px rgba(0,0,0,0.3); }
        .btn-socket { width: 70px; height: 70px; background: #bdc7d4; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: inset 4px 4px 8px #9ea7b5, inset -4px -4px 8px #ffffff; }
        .joy-btn { width: 55px; height: 55px; background: var(--paiho-red); border: none; border-radius: 50%; color: white; font-size: 24px; box-shadow: 0 5px 0 #900; transition: 0.1s; cursor: pointer; }
        .joy-btn:active { transform: translateY(4px); box-shadow: 0 1px 0 #900; }
        .up { grid-column: 2; } .left { grid-column: 1; grid-row: 2; } .down { grid-column: 2; grid-row: 2; } .right { grid-column: 3; grid-row: 2; }
        #score-ui { position: absolute; top: 15px; left: 20px; color: white; font-weight: 900; pointer-events: none; }
    </style>
</head>
<body>

<div id="header"><div style="letter-spacing:4px; font-weight:900;">PAIHO <span style="color:var(--paiho-red)">ELITE IMPACT</span></div></div>
<div id="game-container"><div id="score-ui">得分: <span id="score-val">0</span></div></div>
<div id="controls">
    <div class="btn-socket up"><button class="joy-btn" onclick="setDir(0,1)">▲</button></div>
    <div class="btn-socket left"><button class="joy-btn" onclick="setDir(-1,0)">◀</button></div>
    <div class="btn-socket down"><button class="joy-btn" onclick="setDir(0,-1)">▼</button></div>
    <div class="btn-socket right"><button class="joy-btn" onclick="setDir(1,0)">▶</button></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<script>
    let scene, camera, renderer, snake = [], eyelet, particles = [];
    let dx = 0, dz = 1, score = 0, lastTick = 0;
    let shakeIntensity = 0;
    const spacing = 2.05;

    function init() {
        const container = document.getElementById('game-container');
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a1a);

        camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.set(0, 20, 16);
        camera.lookAt(0, 0, 0);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.shadowMap.enabled = true;
        container.appendChild(renderer.domElement);

        // 織帶貼圖
        const texture = new THREE.TextureLoader().load('https://material.paiho.com/upload/BRD2147-J01F.jpg');
        texture.wrapS = texture.wrapT = THREE.RepeatWrapping;

        // 光源
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        const light = new THREE.DirectionalLight(0xffffff, 0.8);
        light.position.set(10, 20, 10);
        light.castShadow = true;
        scene.add(light);

        // 地面
        const ground = new THREE.Mesh(new THREE.PlaneGeometry(30,30), new THREE.MeshStandardMaterial({color: 0x222222}));
        ground.rotation.x = -Math.PI/2;
        ground.receiveShadow = true;
        scene.add(ground);
        scene.add(new THREE.GridHelper(24, 12, 0x444444, 0x222222));

        // 初始蛇
        for(let i=0; i<3; i++) addPart(0, i, texture);

        // 3D 鞋眼孔
        eyelet = new THREE.Mesh(
            new THREE.TorusGeometry(0.7, 0.25, 16, 100),
            new THREE.MeshStandardMaterial({ color: 0xd4af37, metalness: 0.9, roughness: 0.1 })
        );
        eyelet.rotation.x = Math.PI/2;
        eyelet.position.set(4, 0.2, -4);
        scene.add(eyelet);
    }

    function addPart(x, z, tex) {
        const geo = new THREE.BoxGeometry(1.9, 0.8, 1.9);
        const mat = new THREE.MeshStandardMaterial({ map: tex });
        const part = new THREE.Mesh(geo, mat);
        part.position.set(x * spacing, 0.4, z * spacing);
        part.castShadow = true;
        scene.add(part);
        snake.push(part);
    }

    function triggerImpact(pos) {
        shakeIntensity = 0.5; // 觸發震動
        for(let i=0; i<35; i++) {
            const p = new THREE.Mesh(new THREE.SphereGeometry(0.15, 8, 8), new THREE.MeshBasicMaterial({color: 0xe60012}));
            p.position.copy(pos);
            const angle = Math.random() * Math.PI * 2;
            const speed = Math.random() * 0.6 + 0.2;
            p.userData = { vx: Math.cos(angle)*speed, vy: Math.random()*0.8, vz: Math.sin(angle)*speed, life: 1 };
            scene.add(p);
            particles.push(p);
        }
    }

    function update() {
        if (dx === 0 && dz === 0) return;
        const headPos = snake[0].position.clone();
        headPos.x += dx * spacing;
        headPos.z -= dz * spacing;

        if (headPos.distanceTo(eyelet.position) < 1.5) {
            score++;
            document.getElementById('score-val').innerText = score;
            triggerImpact(eyelet.position);
            eyelet.position.set((Math.floor(Math.random()*10)-5)*spacing, 0.2, (Math.floor(Math.random()*10)-5)*spacing);
            const newPart = snake[snake.length-1].clone();
            snake.push(newPart);
            scene.add(newPart);
        }

        for(let i = snake.length - 1; i > 0; i--) snake[i].position.copy(snake[i-1].position);
        snake[0].position.copy(headPos);

        // 撞牆判定
        if(Math.abs(headPos.x) > 13 || Math.abs(headPos.z) > 13) location.reload();
    }

    function animate(t) {
        requestAnimationFrame(animate);
        
        // 處理震動
        if (shakeIntensity > 0) {
            camera.position.x += (Math.random() - 0.5) * shakeIntensity;
            camera.position.y += (Math.random() - 0.5) * shakeIntensity;
            shakeIntensity *= 0.9; // 衰減
        } else {
            camera.position.set(0, 20, 16);
        }
        camera.lookAt(0, 0, 0);

        if (t - lastTick > 180) {
            update();
            lastTick = t;
        }

        particles.forEach((p, i) => {
            p.position.x += p.userData.vx; p.position.y += p.userData.vy; p.position.z += p.userData.vz;
            p.userData.vy -= 0.03; p.userData.life -= 0.02;
            p.scale.setScalar(p.userData.life);
            if(p.userData.life <= 0) { scene.remove(p); particles.splice(i, 1); }
        });

        renderer.render(scene, camera);
    }

    function setDir(x, z) { if ((x !== 0 && dx === -x) || (z !== 0 && dz === -z)) return; dx = x; dz = z; }

    window.onload = () => { init(); animate(0); };
</script>
</body>
</html>
