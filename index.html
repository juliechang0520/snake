<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAIHO 3D Elite - Pro Arcade</title>
    <style>
        :root { --paiho-red: #e60012; --panel-bg: #d1d9e6; }
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; height: 100vh; }
        
        #header { height: 10%; background: #1a1a1a; display: flex; align-items: center; justify-content: center; color: white; border-bottom: 2px solid var(--paiho-red); z-index: 10; }
        #game-container { flex: 1; position: relative; background: #222; cursor: grab; }
        
        /* 3D 擬真控制板 (25%) */
        #controls { 
            height: 25%; background: var(--panel-bg); 
            display: grid; grid-template-columns: repeat(3, 1fr); 
            align-items: center; justify-items: center;
            box-shadow: inset 0 10px 20px rgba(0,0,0,0.3); border-top: 4px solid #888;
        }
        .btn-base {
            width: 75px; height: 75px; background: #bdc7d4; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: inset 5px 5px 10px #9ea7b5, inset -5px -5px 10px #ffffff;
        }
        .joy-btn {
            width: 58px; height: 58px; background: var(--paiho-red); border: none; border-radius: 50%;
            color: white; font-size: 24px; cursor: pointer;
            box-shadow: 0 6px 0 #900, 0 8px 15px rgba(0,0,0,0.4);
            transition: 0.1s; -webkit-tap-highlight-color: transparent;
        }
        .joy-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #900; }
        .up { grid-column: 2; } .left { grid-column: 1; grid-row: 2; }
        .down { grid-column: 2; grid-row: 2; } .right { grid-column: 3; grid-row: 2; }
        
        #score-overlay { position: absolute; top: 10px; left: 20px; color: white; font-weight: 900; pointer-events: none; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

<div id="header"><div style="letter-spacing:5px;">PAIHO <b>ELITE 3D</b></div></div>

<div id="game-container">
    <div id="score-overlay">SCORE: <span id="score-val">0</span></div>
</div>

<div id="controls">
    <div class="btn-base up"><button class="joy-btn" onclick="setDir(0,1)">▲</button></div>
    <div class="btn-base left"><button class="joy-btn" onclick="setDir(-1,0)">◀</button></div>
    <div class="btn-base down"><button class="joy-btn" onclick="setDir(0,-1)">▼</button></div>
    <div class="btn-base right"><button class="joy-btn" onclick="setDir(1,0)">▶</button></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<script>
    let scene, camera, renderer, snake = [], eyelet, particles = [];
    let dx = 0, dz = 1, score = 0, steps = 0;
    const gridSize = 12, spacing = 2;

    init();
    animate();

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a1a);

        camera = new THREE.PerspectiveCamera(45, window.innerWidth / (window.innerHeight * 0.65), 0.1, 1000);
        camera.position.set(0, 18, 14);
        camera.lookAt(0, 0, -2);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight * 0.65);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.getElementById('game-container').appendChild(renderer.domElement);

        // 光源設定
        const ambient = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambient);

        const sun = new THREE.DirectionalLight(0xffffff, 0.8);
        sun.position.set(10, 20, 10);
        sun.castShadow = true;
        sun.shadow.mapSize.width = 1024;
        sun.shadow.mapSize.height = 1024;
        scene.add(sun);

        // 地板 (運動鞋紋理感)
        const groundGeo = new THREE.BoxGeometry(30, 0.5, 30);
        const groundMat = new THREE.MeshStandardMaterial({ color: 0x243441, roughness: 0.8 });
        const ground = new THREE.Mesh(groundGeo, groundMat);
        ground.position.y = -0.25;
        ground.receiveShadow = true;
        scene.add(ground);

        // 格線輔助
        const gridHelper = new THREE.GridHelper(24, 12, 0xffffff, 0x333333);
        gridHelper.position.y = 0.01;
        scene.add(gridHelper);

        // 初始化蛇
        for(let i=0; i<3; i++) createSnakePart(0, -i);

        // 3D 鞋眼孔
        const torusGeo = new THREE.TorusGeometry(0.7, 0.2, 16, 100);
        const torusMat = new THREE.MeshStandardMaterial({ color: 0xd4af37, metalness: 0.9, roughness: 0.1 });
        eyelet = new THREE.Mesh(torusGeo, torusMat);
        eyelet.rotation.x = Math.PI / 2;
        eyelet.castShadow = true;
        spawnEyelet();
        scene.add(eyelet);
    }

    function createSnakePart(x, z) {
        const geo = new THREE.BoxGeometry(1.7, 0.8, 1.7);
        const mat = new THREE.MeshStandardMaterial({ color: 0xe60012, roughness: 0.4 });
        const part = new THREE.Mesh(geo, mat);
        part.position.set(x * spacing, 0.4, -z * spacing);
        part.castShadow = true;
        scene.add(part);
        snake.push(part);
    }

    function spawnEyelet() {
        eyelet.position.set(
            (Math.floor(Math.random() * 10) - 5) * spacing,
            0.2,
            (Math.floor(Math.random() * 10) - 5) * spacing
        );
    }

    function setDir(x, z) {
        if ((x !== 0 && dx === -x) || (z !== 0 && dz === -z)) return;
        dx = x; dz = z;
    }

    function explode(pos, type) {
        for(let i=0; i<40; i++) {
            const geo = new THREE.SphereGeometry(0.15, 8, 8);
            const mat = new THREE.MeshBasicMaterial({ color: Math.random() > 0.5 ? 0xe60012 : 0xffffff });
            const p = new THREE.Mesh(geo, mat);
            p.position.copy(pos);
            const angle = Math.random() * Math.PI * 2;
            const speed = Math.random() * 0.4 + 0.1;
            p.userData = {
                vx: Math.cos(angle) * speed,
                vy: Math.random() * 0.5 + 0.2,
                vz: Math.sin(angle) * speed,
                life: 1.0
            };
            scene.add(p);
            particles.push(p);
        }
    }

    function update() {
        if (dx === 0 && dz === 0) return;

        const nextPos = snake[0].position.clone();
        nextPos.x += dx * spacing;
        nextPos.z -= dz * spacing;

        // 吃到孔洞
        if (nextPos.distanceTo(eyelet.position) < 1) {
            score++; steps++;
            document.getElementById('score-val').innerText = score;
            explode(eyelet.position, steps % 2);
            spawnEyelet();
            createSnakePart(0, 0); // 增加長度
        }

        // 移動身體
        for(let i = snake.length - 1; i > 0; i--) {
            snake[i].position.copy(snake[i-1].position);
        }
        snake[0].position.copy(nextPos);

        // 粒子更新
        particles.forEach((p, i) => {
            p.position.x += p.userData.vx;
            p.position.y += p.userData.vy;
            p.position.z += p.userData.vz;
            p.userData.vy -= 0.02; // 重力
            p.userData.life -= 0.02;
            p.scale.setScalar(p.userData.life);
            if(p.userData.life <= 0) {
                scene.remove(p);
                particles.splice(i, 1);
            }
        });

        // 邊界檢查
        if(Math.abs(nextPos.x) > 13 || Math.abs(nextPos.z) > 13) location.reload();
    }

    let lastTick = 0;
    function animate(t) {
        requestAnimationFrame(animate);
        if (t - lastTick > 200) {
            update();
            lastTick = t;
        }
        renderer.render(scene, camera);
    }

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / (window.innerHeight * 0.65);
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight * 0.65);
    });
</script>
</body>
</html>
